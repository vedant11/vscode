# This pipeline is for PRs only
trigger: none

resources:
  containers:
    - container: vscode-x64
      image: vscodehub.azurecr.io/vscode-linux-build-agent:bionic-x64
      endpoint: VSCodeHub
      options: --user 0:0

stages:
  - stage: Compile
    jobs:
      - job: Compile
        pool:
          vmImage: "Ubuntu-18.04"
        container: vscode-x64
        variables:
          VSCODE_ARCH: x64
        steps:
          - template: build/azure-pipelines/product-compile.yml
      - job: Hygiene
        pool:
          vmImage: "Ubuntu-18.04"
        container: vscode-x64
        variables:
          VSCODE_ARCH: x64
        steps:
          - template: build/azure-pipelines/product-hygiene.yml

  - stage: Windows
    dependsOn:
      - Compile
    pool:
      vmImage: VS2017-Win2016
    jobs:
      - job: Windows
        timeoutInMinutes: 90
        variables:
          VSCODE_ARCH: x64
        steps:
          - template: build/azure-pipelines/win32/product-build-win32.yml

  - stage: Linux
    dependsOn:
      - Compile
    pool:
      vmImage: "Ubuntu-18.04"
    jobs:
      - job: Linux
        container: vscode-x64
        variables:
          VSCODE_ARCH: x64
          NPM_ARCH: x64
        steps:
          - template: build/azure-pipelines/linux/product-build-linux.yml

  - stage: macOS
    dependsOn:
      - Compile
    pool:
      vmImage: macOS-latest
    jobs:
      - job: macOS
        timeoutInMinutes: 90
        variables:
          VSCODE_ARCH: x64
        steps:
          - template: build/azure-pipelines/darwin/product-build-darwin.yml
